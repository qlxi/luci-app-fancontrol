name: Build luci-app-fancontrol for GL-AXT1800 using LiBwrt-op

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (package source)
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libltdl-dev libncurses5-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build patch pkgconf python3 python3-pyelftools python3-setuptools python3-docutils qemu-utils rsync scons squashfs-tools subversion swig texinfo texlive uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

      - name: Clone LiBwrt-op OpenWrt source
        run: |
          git clone --depth 1 --single-branch -b k6.12-nss https://github.com/LiBwrt-op/openwrt-6.x.git openwrt
          cd openwrt

      - name: Update feeds and add custom package
        working-directory: openwrt
        run: |
          echo "src-link custom ${{ github.workspace }}" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a -p custom

      - name: Prepare config
        working-directory: openwrt
        run: make defconfig

      - name: Compile package
        working-directory: openwrt
        run: |
          make download -j$(nproc)
          make package/luci-app-fancontrol/compile V=s -j$(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-fancontrol-ipk
          path: openwrt/bin/packages/aarch64_cortex-a53/custom/*.ipk
